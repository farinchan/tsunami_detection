<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Monitoring Deteksi Ombak</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-card {
            transition: all 0.3s ease;
        }
        .status-tenang { border-left: 5px solid #28a745; }
        .status-rendah { border-left: 5px solid #28a745; }
        .status-sedang { border-left: 5px solid #ffc107; }
        .status-tinggi { border-left: 5px solid #fd7e14; }
        .status-sangat-tinggi { border-left: 5px solid #dc3545; }
        .status-extreme { border-left: 5px solid #6f42c1; }
        
        .video-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .connection-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .connected { background-color: #28a745; }
        .disconnected { background-color: #dc3545; }
        
        .config-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-water"></i> Sistem Monitoring Deteksi Ombak
            </span>
            <div class="d-flex">
                <span class="connection-status" id="connectionStatus"></span>
                <span id="connectionText">Disconnected</span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Panel Kontrol -->
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-play-circle"></i> Kontrol System</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" id="startBtn" onclick="startMonitoring()">
                                <i class="fas fa-play"></i> Mulai Monitoring
                            </button>
                            <button class="btn btn-danger" id="stopBtn" onclick="stopMonitoring()" disabled>
                                <i class="fas fa-stop"></i> Hentikan Monitoring
                            </button>
                        </div>
                        <hr>
                        <div class="status-card card" id="statusCard">
                            <div class="card-body text-center">
                                <h6 class="card-title">Status Ombak</h6>
                                <h4 id="statusText" class="mb-2">Tenang</h4>
                                <p class="mb-1">Ketinggian Y: <span id="peakY">-</span></p>
                                <p class="mb-1">Garis Terdeteksi: <span id="lineCount">0</span></p>
                                <p class="mb-0"><small id="lastUpdate">-</small></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Konfigurasi -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cog"></i> Konfigurasi</h5>
                    </div>
                    <div class="card-body">
                        <form id="configForm">
                            <div class="config-section">
                                <h6>Sumber Video</h6>
                                <div class="mb-3">
                                    <label class="form-label">URL RTSP/HTTP</label>
                                    <input type="text" class="form-control" id="sumberVideo" 
                                           placeholder="rtsp://192.168.1.100:554/stream">
                                </div>
                            </div>

                            <div class="config-section">
                                <h6>Garis Deteksi (Y Coordinate)</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label">Extreme</label>
                                        <input type="number" class="form-control" id="garisExtreme" value="180">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Sangat Tinggi</label>
                                        <input type="number" class="form-control" id="garisSangatTinggi" value="210">
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <label class="form-label">Tinggi</label>
                                        <input type="number" class="form-control" id="garisTinggi" value="230">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Sedang</label>
                                        <input type="number" class="form-control" id="garisSedang" value="250">
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <label class="form-label">Rendah</label>
                                        <input type="number" class="form-control" id="garisRendah" value="280">
                                    </div>
                                </div>
                            </div>

                            <div class="config-section">
                                <h6>Parameter Canny Edge</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label">Ambang Bawah</label>
                                        <input type="number" class="form-control" id="ambangBawah" value="50">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Ambang Atas</label>
                                        <input type="number" class="form-control" id="ambangAtas" value="150">
                                    </div>
                                </div>
                            </div>

                            <div class="config-section">
                                <h6>Parameter Hough Transform</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label">Threshold</label>
                                        <input type="number" class="form-control" id="houghThreshold" value="80">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Min Panjang</label>
                                        <input type="number" class="form-control" id="houghMinPanjang" value="90">
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <label class="form-label">Max Jarak</label>
                                        <input type="number" class="form-control" id="houghMaxJarak" value="30">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Save Interval</label>
                                        <input type="number" class="form-control" id="saveInterval" value="30">
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save"></i> Simpan Konfigurasi
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Video dan Chart -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-video"></i> Live Video Feed</h5>
                    </div>
                    <div class="card-body">
                        <div class="video-container">
                            <img id="videoFeed" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" 
                                 class="img-fluid w-100" style="min-height: 300px; background: #333;">
                            <div class="video-overlay" id="videoOverlay">
                                <div>Status: <span id="overlayStatus">Waiting...</span></div>
                                <div>Frame: <span id="overlayFrame">0</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Grafik Ketinggian Ombak</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="waveChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Socket.IO connection
        const socket = io();
        let isMonitoring = false;
        let waveChart = null;
        const waveData = [];

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('waveChart').getContext('2d');
            waveChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Ketinggian Ombak (Y)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            reverse: true, // Y coordinate terbalik
                            title: {
                                display: true,
                                text: 'Y Coordinate'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Waktu'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }

        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
            loadConfig();
        });

        socket.on('connection_status', function(data) {
            updateConnectionStatus(data.connected);
        });

        socket.on('wave_data', function(data) {
            updateStatus(data);
            updateChart(data);
        });

        socket.on('video_frame', function(data) {
            document.getElementById('videoFeed').src = 'data:image/jpeg;base64,' + data.frame;
        });

        // Update functions
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            if (connected) {
                statusEl.className = 'connection-status connected';
                textEl.textContent = 'Connected';
            } else {
                statusEl.className = 'connection-status disconnected';
                textEl.textContent = 'Disconnected';
            }
        }

        function updateStatus(data) {
            document.getElementById('statusText').textContent = data.status_ombak;
            document.getElementById('peakY').textContent = data.puncak_ombak_y;
            document.getElementById('lineCount').textContent = data.jumlah_garis;
            document.getElementById('lastUpdate').textContent = data.timestamp;
            
            // Update overlay
            document.getElementById('overlayStatus').textContent = data.status_ombak;
            document.getElementById('overlayFrame').textContent = data.frame_count;
            
            // Update status card color
            const statusCard = document.getElementById('statusCard');
            statusCard.className = 'status-card card';
            
            if (data.status_ombak.includes('Tenang')) {
                statusCard.classList.add('status-tenang');
            } else if (data.status_ombak.includes('Rendah')) {
                statusCard.classList.add('status-rendah');
            } else if (data.status_ombak.includes('Sedang')) {
                statusCard.classList.add('status-sedang');
            } else if (data.status_ombak.includes('Tinggi') && !data.status_ombak.includes('SANGAT')) {
                statusCard.classList.add('status-tinggi');
            } else if (data.status_ombak.includes('SANGAT TINGGI')) {
                statusCard.classList.add('status-sangat-tinggi');
            } else if (data.status_ombak.includes('EXTREME')) {
                statusCard.classList.add('status-extreme');
            }
        }

        function updateChart(data) {
            const now = new Date().toLocaleTimeString();
            
            // Add new data
            waveData.push({
                time: now,
                height: data.puncak_ombak_y
            });
            
            // Keep only last 20 points
            if (waveData.length > 20) {
                waveData.shift();
            }
            
            // Update chart
            waveChart.data.labels = waveData.map(d => d.time);
            waveChart.data.datasets[0].data = waveData.map(d => d.height);
            waveChart.update('none');
        }

        // Control functions
        async function startMonitoring() {
            try {
                const response = await fetch('/api/start', { method: 'POST' });
                const result = await response.json();
                
                if (result.status === 'success') {
                    isMonitoring = true;
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                }
            } catch (error) {
                alert('Gagal memulai monitoring: ' + error.message);
            }
        }

        async function stopMonitoring() {
            try {
                const response = await fetch('/api/stop', { method: 'POST' });
                const result = await response.json();
                
                if (result.status === 'success') {
                    isMonitoring = false;
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                }
            } catch (error) {
                alert('Gagal menghentikan monitoring: ' + error.message);
            }
        }

        // Configuration functions
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                document.getElementById('sumberVideo').value = config.SUMBER_VIDEO;
                document.getElementById('garisExtreme').value = config.GARIS_EXTREME_Y;
                document.getElementById('garisSangatTinggi').value = config.GARIS_SANGAT_TINGGI_Y;
                document.getElementById('garisTinggi').value = config.GARIS_TINGGI_Y;
                document.getElementById('garisSedang').value = config.GARIS_SEDANG_Y;
                document.getElementById('garisRendah').value = config.GARIS_RENDAH_Y;
                document.getElementById('ambangBawah').value = config.AMBANG_BAWAH_CANNY;
                document.getElementById('ambangAtas').value = config.AMBANG_ATAS_CANNY;
                document.getElementById('houghThreshold').value = config.HOUGH_THRESHOLD;
                document.getElementById('houghMinPanjang').value = config.HOUGH_MIN_PANJANG_GARIS;
                document.getElementById('houghMaxJarak').value = config.HOUGH_MAKS_JARAK_GARIS;
                document.getElementById('saveInterval').value = config.SIMPAN_SETIAP_N_FRAME;
                
                if (config.is_running) {
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    isMonitoring = true;
                }
            } catch (error) {
                console.error('Gagal memuat konfigurasi:', error);
            }
        }

        document.getElementById('configForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const configData = {
                SUMBER_VIDEO: document.getElementById('sumberVideo').value,
                GARIS_EXTREME_Y: parseInt(document.getElementById('garisExtreme').value),
                GARIS_SANGAT_TINGGI_Y: parseInt(document.getElementById('garisSangatTinggi').value),
                GARIS_TINGGI_Y: parseInt(document.getElementById('garisTinggi').value),
                GARIS_SEDANG_Y: parseInt(document.getElementById('garisSedang').value),
                GARIS_RENDAH_Y: parseInt(document.getElementById('garisRendah').value),
                AMBANG_BAWAH_CANNY: parseInt(document.getElementById('ambangBawah').value),
                AMBANG_ATAS_CANNY: parseInt(document.getElementById('ambangAtas').value),
                HOUGH_THRESHOLD: parseInt(document.getElementById('houghThreshold').value),
                HOUGH_MIN_PANJANG_GARIS: parseInt(document.getElementById('houghMinPanjang').value),
                HOUGH_MAKS_JARAK_GARIS: parseInt(document.getElementById('houghMaxJarak').value),
                SIMPAN_SETIAP_N_FRAME: parseInt(document.getElementById('saveInterval').value)
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Konfigurasi berhasil disimpan!');
                } else {
                    alert('Gagal menyimpan konfigurasi: ' + result.message);
                }
            } catch (error) {
                alert('Gagal menyimpan konfigurasi: ' + error.message);
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
        });
    </script>
</body>
</html>